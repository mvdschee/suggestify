/*!
* suggestify v1.2.3
* (c) 2021 Max van der Schee
* @license MIT
*/(function(a,r){typeof exports=="object"&&typeof module!="undefined"?module.exports=r():typeof define=="function"&&define.amd?define(r):(a=typeof globalThis!="undefined"?globalThis:a||self,a.suggestify=r())})(this,function(){"use strict";let a=(i=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(i));for(;i--;){let s=t[i]&63;s<36?e+=s.toString(36):s<62?e+=(s-26).toString(36).toUpperCase():s<63?e+="_":e+="-"}return e};function r(i){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&grave;","/":"&#x2F;"},t=/[&<>"'/`]/gi;return i.replace(t,s=>e[s])}const m=(i,e="_default")=>t=>(i[t]||i[e])();function h(i,e){for(var t in e)i.setAttribute(t,e[t])}class f{engine;class;url;blur;instant;t;icon;onComplete;root;input;clearBtn;submitBtn;list=null;listItems=[];selectedIndex=-1;searchInput="";cache={};timeout=250;constructor(e,t){this.root=typeof e=="string"?document.querySelector(e):e,this.input=this.root&&this.root.querySelector("input"),this.clearBtn=this.root&&this.root.querySelector('button:not([type="submit"])'),this.submitBtn=this.root&&this.root.querySelector('button[type="submit"]'),this.url=t.url||"?q=",this.class=t.class||"suggestify",this.blur=t.blur!==void 0?t.blur:!0,this.instant=t.instant!==void 0?t.instant:!1,this.icon=t.icon!==void 0?t.icon:!0,this.t=t.translations||null,this.engine=t.engine,this.onComplete=t.onComplete,this.initialize()}initialize(){if(!this.root)throw new Error("Selector not found");if(!this.input)throw new Error("Input field missing");this.initializeDOM(),this.input.addEventListener("keydown",this.keyHandler,{passive:!0}),this.input.addEventListener("input",this.searchInputHandler,{passive:!0}),this.clearBtn&&this.clearBtn.addEventListener("click",this.clearInput,{passive:!0}),this.submitBtn&&this.submitBtn.addEventListener("click",this.directSearch,{passive:!0}),this.engine&&(this.input.addEventListener("click",this.inputSelected,{passive:!0}),this.blur&&this.input.addEventListener("blur",this.handleBlur,{passive:!0}),this.instant?this.autoSuggest():this.input.addEventListener("mouseover",this.autoSuggest,{once:!0,passive:!0}))}initializeDOM(){const e=`${this.class}-results-${a(5)}`;if(this.root.className=this.class,this.root.setAttribute("role","search"),h(this.input,{class:`${this.class}-input`,autocomplete:"off",autocapitalize:"off",autocorrect:"off",spellcheck:"off"}),this.searchInput=this.input.value,this.icon){const t=document.createElement("i");h(t,{class:`${this.class}-icon`,role:"presentation",focusable:"false","aria-hidden":"true"});const s=t.cloneNode(!1);this.clearBtn.appendChild(t),this.submitBtn.appendChild(s)}h(this.clearBtn,{class:`${this.class}-clear`,hidden:""}),this.submitBtn.className=`${this.class}-submit`,this.engine&&(h(this.input,{role:"combobox","aria-autocomplete":"list","aria-haspopup":"listbox","aria-expanded":"false","aria-owns":e}),this.list=document.createElement("ul"),h(this.list,{id:e,class:`${this.class}-results`,role:"listbox"}),this.root?.appendChild(this.list))}handleBlur=()=>{setTimeout(()=>{this.deleteResultList()},100)};inputSelected=()=>{this.request(this.searchInput).then(e=>{this.deleteResultList(),this.createResultList(e)}).catch(e=>{throw new Error(e.message)})};clearInput=()=>{this.searchInput="",this.input.value="",this.deleteResultList(),this.clearBtn&&(this.clearBtn.hidden=!0)};directSearch=()=>{let e="";if(this.selectedIndex!==-1?e=this.listItems[this.selectedIndex].title:this.searchInput&&(e=this.searchInput.toLowerCase()),this.onComplete&&e){const s=this.listItems.find(n=>n.title===e)?"HIT":"MISS";this.onComplete({value:e,success:s}).then(()=>{window.location.href=`${this.url}${e}`})}else window.location.href=`${this.url}${e}`};selectItemUp=()=>{if(this.listItems.length){const e=this.listItems.length-1,t=this.listItems[this.selectedIndex];t&&t.classList.remove("selected"),this.selectedIndex<=0?this.selectedIndex=e:this.selectedIndex--;const s=this.listItems[this.selectedIndex];s&&(this.input.setAttribute("aria-activedescendant",s.id),s.classList.add("selected"))}};selectItemDown=()=>{if(this.listItems.length){const e=this.listItems.length-1,t=this.listItems[this.selectedIndex];t&&t.classList.remove("selected"),this.selectedIndex===e?this.selectedIndex=0:this.selectedIndex++;const s=this.listItems[this.selectedIndex];s&&(this.input.setAttribute("aria-activedescendant",s.id),s.classList.add("selected"))}};keyHandler=({key:e})=>{const t={Enter:this.directSearch,Escape:this.deleteResultList,ArrowUp:this.selectItemUp,ArrowDown:this.selectItemDown,_default:()=>null};m(t,"_default")(e)};autoSuggest=()=>{this.request(this.searchInput).then(e=>{this.instant&&this.createResultList(e)}).catch(e=>{throw new Error(e.message)})};searchInputHandler=({target:e})=>{this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{const t=e.value.trim();this.searchInput=t?r(t):"",t&&this.clearBtn?this.clearBtn.hidden=!1:this.clearBtn&&(this.clearBtn.hidden=!0),this.engine&&this.request(this.searchInput).then(s=>{this.deleteResultList(),this.createResultList(s)}).catch(s=>{throw new Error(s.message)})},250)};async request(e){const t=e||null,s=JSON.stringify(t);if(this.cache[s])return this.cache[s];const n=`${this.engine}${t?`?q=${t}`:""}`,l=await fetch(n).then(o=>o.json());return this.cache[s]=l,l}banner=e=>{const t=document.createElement("li");t.className=`${this.class}-banner`,e==="suggestions"&&(t.textContent=this.t?.suggestions?this.t?.suggestions:"Suggestions"),e==="empty"&&(t.textContent=this.t?.results?this.t?.results:"No suggestions found"),e!=="results"&&this.list.appendChild(t)};linkHandler=(e,t)=>{e.preventDefault(),this.onComplete?this.onComplete({value:t,success:"HIT"}).then(()=>{window.location.href=`${this.url}${t}`}):window.location.href=`${this.url}${t}`};createResultList(e){if(this.root.classList.add("expanded"),this.input.setAttribute("aria-expanded","true"),this.input.setAttribute("aria-activedescendant",""),this.banner(e.type),e.items.length)for(let t=0;t<e.items.length;t++){const s=document.createElement("li"),n=document.createElement("a"),l=e.items[t],o=`${this.class}-item-${a(6)}`;if(h(n,{class:`${this.class}-link`,href:`${this.url}${l}`}),n.addEventListener("click",c=>this.linkHandler(c,l),{passive:!1}),e.type==="results"){const c=this.searchInput?this.searchInput.split(" "):[];let u=l;for(let d=0;d<c.length;d++){const p=c[d];u=u.replace(p,`<b>${p}</b>`)}n.innerHTML=u}else n.textContent=l;s.id=o,s.title=l,s.appendChild(n),this.listItems.push(s)}else{const t=document.createElement("li"),s=document.createElement("a");h(s,{class:`${this.class}-link`,href:`${this.url}${this.searchInput}`}),s.addEventListener("click",n=>this.linkHandler(n,this.searchInput),{passive:!1}),s.textContent=this.searchInput,t.title=this.searchInput,t.appendChild(s),this.listItems.push(t)}for(let t=0;t<this.listItems.length;t++)this.list.appendChild(this.listItems[t])}deleteResultList=()=>{this.list&&(this.root.classList.remove("expanded"),this.input.setAttribute("aria-expanded","false"),this.input.setAttribute("aria-activedescendant",""),this.list.innerHTML="",this.listItems=[],this.selectedIndex=-1)}}return f});
